name: WebGPUReconstuct Build
description: Build WebGPUReconstuct

inputs:
  platform:
    required: true
    description: The target platform
  backend:
    required: true
    description: Which backend to use (wgpu or dawn)

runs:
  using: composite
  steps:
    - name: Install glfw dependencies
      if: ${{ inputs.platform == 'linux' }}
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install libwayland-dev libxkbcommon-dev xorg-dev

# Setup correct Java version
    - name: Setup Java
      if: ${{ inputs.platform == 'android' }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

# Dawn dependencies
    - name: Install Dawn dependencies
      if: ${{ inputs.platform == 'linux' && inputs.backend == 'dawn'}}
      shell: bash
      run: |
        sudo apt-get install libxrandr-dev libxinerama-dev libxcursor-dev mesa-common-dev libx11-xcb-dev pkg-config nodejs npm

# Configure, fetch modules and build
    - name: Configure build
      if: ${{ inputs.platform != 'android' }}
      shell: bash
      run: |
        python ./configure.py --${{ inputs.backend }} --target release

    - name: Configure build (Android)
      if: ${{ inputs.platform == 'android' }}
      shell: bash
      run: |
        python ./configure.py --${{ inputs.backend }} --target release --no-host --android --ndk $ANDROID_NDK

    - name: Fetch modules
      shell: bash
      run: |
        python ./fetch_modules.py

    - name: Build
      shell: bash
      run: |
        python ./build.py
